<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <title>Dekklager</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="style.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #2b2b2b;
      color: white;
    }

    .menu {
      margin-bottom: 1em;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: #3c3c3c;
      border-radius: 8px;
    }

    th, td {
      border: 1px solid #666;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #444;
    }

    tr:hover {
      background: #555;
    }

    .hidden {
      display: none;
    }

    form {
      background: #444;
      padding: 10px;
      border-radius: 8px;
      margin-top: 1em;
    }

    input, select {
      padding: 6px;
      margin: 4px;
    }

    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #125ca1;
    }

    /* üîç Filterfelt */
    #filterContainer {
      background: #3b3b3b;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    #filterContainer input, #filterContainer select {
      margin-right: 10px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #2b2b2b;
      color: white;
    }

  </style>
</head>
<body>

<div id="header"></div>

<!-- <script>
  fetch("header.html")
    .then(res => res.text())
    .then(html => { document.getElementById("header").innerHTML = html; });
</script> -->

<h1>üõû Dekklager</h1>

<div class="menu">
  <button onclick="visNyttSkjema(true)">‚ûï Registrer nytt dekk</button>
  <button onclick="eksporterDekkCSV()">üì§ Eksporter til CSV</button>
</div>

<!-- üîç Filterseksjon -->
<div id="filterContainer">
  <label for="filterType">S√∏k etter:</label>
  <select id="filterType">
    <option value="regnr">Reg.nr</option>
    <option value="lokasjon">Lokasjon</option>
  </select>
  <input type="text" id="filterInput" placeholder="S√∏k her..." oninput="filtrerDekklager()">
</div>

<table id="dekklagerTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Reg.nr</th>
      <th>Lokasjon</th>
      <th>Type</th>
      <th>Dimensjon</th>
      <th>Antall</th>
      <th>Innlevert</th>
      <th>Utlevert</th>
      <th>Kunde-ID</th>
      <th>Jobb-ID</th>
      <th>Handling</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Nytt dekk-skjema -->
<form id="nyDekkForm" style="display: none;">
  <h3>‚ûï Legg til nytt dekk</h3>

  <label for="nyRegnr">Reg.nr:</label>
  <input type="text" id="nyRegnr" required placeholder="F.eks. AB12345">

  <label for="nyDimensjon">Dimensjon:</label>
  <input type="text" id="nyDimensjon" required placeholder="F.eks. 205/55 R16">

  <label for="nyAntall">Antall:</label>
  <input type="number" id="nyAntall" required min="1" value="4">

  <label for="nyLokasjon">Lokasjon:</label>
  <select id="nyLokasjon">
    <option value="">Ingen</option>
    <option value="Bl√•">Bl√•</option>
    <option value="Hvit">Hvit</option>
    <option value="Sutre">Sutre</option>
  </select>

  <label for="nyType">Type dekk:</label>
  <select id="nyType">
    <option value="">Ikke valgt</option>
    <option value="Vinterdekk">Vinterdekk</option>
    <option value="Sommerdekk">Sommerdekk</option>
    <option value="Piggdekk">Piggdekk</option>
  </select>

  <br><br>
  <button type="submit">üíæ Legg til i lageret</button>
</form>

<script>

  fetch("header.html")
    .then(res => res.text())
    .then(html => { document.getElementById("header").innerHTML = html; });


  const API_BASE =
      window.location.hostname === "localhost"
        ? "http://localhost:3000/api"
        : "https://plannerweb-backend.onrender.com/api";

  let dekkliste = [];

  async function hentDekklager() {
    try {
      const res = await fetch(`${API_BASE}/dekklager`, { credentials: 'include' });
      if (!res.ok) throw new Error("Feil ved henting av dekklager");
      dekkliste = await res.json();
      visDekklager(dekkliste);
    } catch (err) {
      console.error("Feil:", err);
    }
  }

  function visDekklager(data) {
    const tbody = document.querySelector("#dekklagerTable tbody");
    tbody.innerHTML = "";
    data.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.regnr || '-'}</td>
        <td>${r.lokasjon || '-'}</td>
        <td>${r.type || '-'}</td>
        <td>${r.dimensjon || '-'}</td>
        <td>${r.antall || 0}</td>
        <td>${r.dato_innlevert ? new Date(r.dato_innlevert).toLocaleDateString() : '-'}</td>
        <td>${r.dato_utlevert ? new Date(r.dato_utlevert).toLocaleDateString() : '-'}</td>
        <td>${r.kunde_id || '-'}</td>
        <td>${r.jobb_id || '-'}</td>
        <td><button onclick="slettDekk(${r.id})">üóëÔ∏è</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function slettDekk(id) {
    if (!confirm("Vil du slette dette dekket fra lageret?")) return;
    try {
      const res = await fetch(`${API_BASE}/dekklager/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      if (!res.ok) throw new Error("Feil ved sletting");
      hentDekklager();
    } catch (err) {
      console.error("Sletting feilet:", err);
    }
  }

/*   function visNyttSkjema(vis) {
    document.getElementById("nyDekkForm").classList.toggle("hidden", !vis);
  } */
 function visNyttSkjema(vis) {
  const skjema = document.getElementById("nyDekkForm");
  skjema.style.display = vis ? "block" : "none";
}


// H√•ndter innsending av nytt dekk
document.getElementById("nyDekkForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const data = {
    regnr: document.getElementById("nyRegnr").value.trim(),
    dimensjon: document.getElementById("nyDimensjon").value.trim(),
    antall: parseInt(document.getElementById("nyAntall").value),
    lokasjon: document.getElementById("nyLokasjon").value || null,
    type: document.getElementById("nyType").value || null,
  };

  try {
    const res = await fetch(`${API_BASE}/dekklager`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(data),
    });

    if (!res.ok) throw new Error("Kunne ikke legge til dekk");
    alert("‚úÖ Dekk lagt til i lageret!");
    document.getElementById("nyDekkForm").reset();
    document.getElementById("nyDekkForm").style.display = "none";
    hentDekklager();
  } catch (err) {
    console.error("Feil ved oppretting:", err);
    alert("‚ùå Feil ved oppretting av dekk. Se konsoll for detaljer.");
  }
});

  // üîç Filterfunksjon
  function filtrerDekklager() {
    const felt = document.getElementById("filterType").value;
    const s√∏k = document.getElementById("filterInput").value.toLowerCase();

    const filtrert = dekkliste.filter(d => {
      const verdi = (d[felt] || "").toString().toLowerCase();
      return verdi.includes(s√∏k);
    });

    visDekklager(filtrert);
  }

  // N√•r du klikker p√• "Utlevert"
document.querySelectorAll(".utlevertBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    if (!confirm("Bekreft at dekket er utlevert?")) return;

    try {
      const res = await fetch(`${API_BASE}/dekklager/${id}/utlevert`, {
        method: "PUT",
        credentials: "include"
      });
      if (!res.ok) throw new Error("Kunne ikke oppdatere dekkstatus");
      alert("‚úÖ Dekk markert som utlevert!");
      hentDekklager();
    } catch (err) {
      console.error("Feil ved utlevering:", err);
      alert("‚ùå Feil ved utlevering");
    }
  });
});

// N√•r du klikker p√• "Endre"
document.querySelectorAll(".endreBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    const nyLokasjon = prompt("Ny lokasjon (Bl√•, Hvit, Sutre):");
    if (!nyLokasjon) return;

    try {
      const res = await fetch(`${API_BASE}/dekklager/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ lokasjon: nyLokasjon })
      });
      if (!res.ok) throw new Error("Kunne ikke oppdatere dekk");
      alert("‚úÖ Dekk oppdatert!");
      hentDekklager();
    } catch (err) {
      console.error("Feil ved oppdatering:", err);
      alert("‚ùå Feil ved oppdatering");
    }
  });
});


  function eksporterDekkCSV() {
    if (!dekkliste || dekkliste.length === 0) {
      alert("Ingen dekk √• eksportere.");
      return;
    }

    const headers = ["ID","Regnr","Lokasjon","Type","Dimensjon","Antall","Innlevert","Utlevert","Kunde-ID","Jobb-ID"];
    const rows = dekkliste.map(d => [
      d.id, d.regnr, d.lokasjon, d.type, d.dimensjon, d.antall,
      d.dato_innlevert, d.dato_utlevert, d.kunde_id, d.jobb_id
    ]);

    const csvContent = [headers, ...rows]
      .map(r => r.map(v => `"${String(v ?? '').replace(/"/g, '""')}"`).join(","))
      .join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "dekklager.csv";
    link.click();
  }

  hentDekklager();
</script>
<!-- ü™ü PENERE POPUP FOR REDIGERING -->
<style>
  #popupBakgrunn {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.25s ease;
  }
  #popupBakgrunn.vis {
    display: flex;
    opacity: 1;
  }
  #popupVindu {
    background: #2f2f2f;
    color: #f5f5f5;
    padding: 22px;
    border-radius: 12px;
    width: 440px;
    max-width: 95%;
    box-shadow: 0 0 25px rgba(0,0,0,0.6);
    animation: popupIn 0.25s ease;
  }
  @keyframes popupIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  #popupVindu h3 {
    margin-top: 0;
    margin-bottom: 10px;
    text-align: center;
    font-weight: 600;
    color: #fff;
  }
  #popupVindu label {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    font-size: 0.9em;
    color: #ddd;
  }
  #popupVindu input, #popupVindu select {
    width: 100%;
    margin-top: 2px;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #555;
    background: #1f1f1f;
    color: white;
  }
  fieldset {
    border: 1px solid #555;
    border-radius: 8px;
    margin-top: 12px;
    padding: 10px;
  }
  legend {
    font-size: 0.85em;
    padding: 0 6px;
    color: #ccc;
  }
  .knapper {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 18px;
  }
  .knapper button {
    background: #1976d2;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
  }
  .knapper button:hover {
    background: #125ca1;
  }
  #avbrytBtn {
    background: #555;
  }
  #avbrytBtn:hover {
    background: #666;
  }
</style>
<!-- üîß POPUP for redigering -->
<div id="popupBakgrunn">
  <div id="popupVindu">
    <h3>üßæ Endre dekk</h3>
    <form id="endreForm">
      <input type="hidden" id="endreId">

      <label>üöó Reg.nr:</label>
      <input type="text" id="endreRegnr">

      <label>üìç Lokasjon:</label>
      <input type="text" id="endreLokasjon">

      <label>üõû Type:</label>
      <select id="endreType">
        <option value="">Velg type...</option>
        <option value="Sommer">Sommer</option>
        <option value="Vinter">Vinter</option>
        <option value="Piggfri">Piggfri</option>
      </select>

      <label>üìè Dimensjon:</label>
      <input type="text" id="endreDimensjon">

      <label>üî¢ Antall:</label>
      <input type="number" id="endreAntall" min="1">

      <fieldset>
        <legend>üìÖ Datoer</legend>
        <label>Innlevert:</label>
        <input type="date" id="endreInnlevert">

        <label>Utlevert:</label>
        <input type="date" id="endreUtlevert">
      </fieldset>

      <fieldset>
        <legend>üë§ Kundeinformasjon</legend>
        <label>Kunde-ID:</label>
        <input type="number" id="endreKundeId">

        <label>Jobb-ID:</label>
        <input type="number" id="endreJobbId">
      </fieldset>

      <div class="knapper">
        <button type="button" id="avbrytBtn">Avbryt</button>
        <button type="submit">üíæ Lagre</button>
      </div>
    </form>
  </div>
</div>

<script>
  // üéØ Dobbeltklikk for √• √•pne popup
   // Fiks for "popup √•pner ikke igjen" ‚Üí fjern display:none riktig
  const popup = document.getElementById("popupBakgrunn");
  const form = document.getElementById("endreForm");

  // √Öpne popup ved dobbeltklikk
  document.addEventListener("dblclick", (e) => {
    const tr = e.target.closest("tr");
    if (!tr || tr.parentNode.tagName !== "TBODY") return;
    const id = tr.children[0].textContent;
    const dekk = dekkliste.find(d => d.id == id);
    if (!dekk) return;

    document.getElementById("endreId").value = dekk.id;
    document.getElementById("endreRegnr").value = dekk.regnr || "";
    document.getElementById("endreLokasjon").value = dekk.lokasjon || "";
    document.getElementById("endreType").value = dekk.type || "";
    document.getElementById("endreDimensjon").value = dekk.dimensjon || "";
    document.getElementById("endreAntall").value = dekk.antall || 1;
    document.getElementById("endreInnlevert").value = dekk.dato_innlevert ? new Date(dekk.dato_innlevert).toISOString().split('T')[0] : "";
    document.getElementById("endreUtlevert").value = dekk.dato_utlevert ? new Date(dekk.dato_utlevert).toISOString().split('T')[0] : "";
    document.getElementById("endreKundeId").value = dekk.kunde_id || "";
    document.getElementById("endreJobbId").value = dekk.jobb_id || "";

    popup.style.display = "flex";
    setTimeout(() => popup.classList.add("vis"), 10);
  });

  // Lukk popup (med fade)
  function lukkPopup() {
    popup.classList.remove("vis");
    setTimeout(() => {
      popup.style.display = "none";
    }, 250);
  }

  document.getElementById("avbrytBtn").addEventListener("click", lukkPopup);
  window.addEventListener("keydown", e => { if (e.key === "Escape") lukkPopup(); });

  // Lagre endringer
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("endreId").value;
    const oppdatert = {
      regnr: document.getElementById("endreRegnr").value.trim(),
      lokasjon: document.getElementById("endreLokasjon").value.trim(),
      type: document.getElementById("endreType").value.trim(),
      dimensjon: document.getElementById("endreDimensjon").value.trim(),
      antall: parseInt(document.getElementById("endreAntall").value),
      dato_innlevert: document.getElementById("endreInnlevert").value || null,
      dato_utlevert: document.getElementById("endreUtlevert").value || null,
      kunde_id: document.getElementById("endreKundeId").value || null,
      jobb_id: document.getElementById("endreJobbId").value || null
    };

    try {
      const res = await fetch(`${API_BASE}/dekklager/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(oppdatert)
      });
      if (!res.ok) throw new Error("Feil ved oppdatering");
      alert("‚úÖ Dekk oppdatert!");
      lukkPopup();
      hentDekklager();
    } catch (err) {
      console.error(err);
      alert("‚ùå Klarte ikke √• oppdatere dekk.");
    }
  });

  // üì§ Eksporter til Excel (.xlsx)
  async function eksporterDekkExcel() {
    if (!dekkliste || dekkliste.length === 0) {
      alert("Ingen data √• eksportere.");
      return;
    }

    // Dynamisk importer XLSX
    const { utils, writeFile } = await import("https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs");

    const ws = utils.json_to_sheet(dekkliste.map(d => ({
      ID: d.id,
      Regnr: d.regnr,
      Lokasjon: d.lokasjon,
      Type: d.type,
      Dimensjon: d.dimensjon,
      Antall: d.antall,
      Innlevert: d.dato_innlevert,
      Utlevert: d.dato_utlevert,
      KundeID: d.kunde_id,
      JobbID: d.jobb_id
    })));

    const wb = utils.book_new();
    utils.book_append_sheet(wb, ws, "Dekklager");
    writeFile(wb, "dekklager.xlsx");
  }

  // Legg til knapp for Excel-eksport
  const excelBtn = document.createElement("button");
  excelBtn.textContent = "üìä Eksporter til Excel";
  excelBtn.onclick = eksporterDekkExcel;
  document.querySelector(".menu").appendChild(excelBtn);
</script>



</body>
</html>
